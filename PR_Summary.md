# Partial Reconfiguration Summary:

All PR regions (we only have one PR region for the first test !?) must:	
1.	be set as design partitions
2.	have associated LogicLock assignments

Altera PR flow uses QII project revisions to manage multiple personas (here: A,B) for all (here: only one) PR regions.

For a PR project, you can use revisions to manage source files for the different personas by pointing to different files for the same region in the different revisions of the same project.

Only internal device resources can be reconfigured using PR:
*	LAB
*	RAM
*	DSP

Peripheral block can not be reconfigured using PR:
*	PLL
*	transceivers
*	I/Os

but they may be able to use dynamic reconfiguration.

When a PR region has multiple personas, each of the persona may have different functionality, however all the PR regions are required to interact with the static region with the same set of signals. In the case of some persona requiring more signals than other personas, the set up signals interacting with the static region must be a superset of all the signals in all the personas in order to get the IO interfaces to be the same -> wrapper logic needed.

# Wrapper logic
is a PR region top-level file used to make all personas look alike to the static region.
Each of the personas would have a wrapper file with the persona logic instantiated within the wrapper.
Wrapper is set as a design partition.

If you have two personas for one PR region (like we have) and Persona #1 uses different number of signals to interact with the static region as Persona #2 -> you have to create wrapper regions for both of the persona.

# Freeze logic
We need to make sure PR region I/Os are static during the PR process.
Create a region in the static region of the design around the PR region allowing the PR host to freeze input signals before PR starts.
Need to isolate PR regions during PR
Inputs: - User logic must hold all non-global PR region inputs at logic '1' (VCC) during PR.
Outputs: - Device automatically holds all PR region outputs at logic '1' (VCC) during PR
–	Static logic and system should be coded to assume 'X' (don't care) during PR
The easiest way to control the inputs to PR regions is by creating a logic around the PR region in RTL.

PR host will set the freeze signal high to drive a '1' to the inputs of the PR region.

Global Signal Promotion
–	limited number of unique global signals that can drive a PR region
–	in order to be global, a clock must be available to all rows in that region

only supported control signal types that can be made global and used in a PR region are:
1.	Clock
2.	Asynchronous clear
3.	Memory write enable
4.	Memory read enable

Same global signal cannot be used as asynchronous clear in PR region and as synchronous clear in static region.

Sizing PR region
When making logiclock assignments for the PR region its important to ensure that the region is large enough to contain the largest persona assignet to it. As a general rule of thumb, place your largest persona in the base revision of the design. The PR partition is always place in physical boundaries.

Configuration Frames for PR   c.f. DEMO Partial Reconfiguration PC (17:35 /54:26; Ch. 3.21)

# SCRUB Mode
In SCRUB mode PR the unchanging CRAM bits of an entire column are scrubbed-back to the original values, and the CRAM bits for a changing region are written completely afresh whenever a region being partially reconfigured.
--> This method results in a smaller bitstream size
--> You should not create any PR regions that verticall overlaps !!

# AND/OR Mode 	cf. Ch. 3.23
Two pass programming
1.	Pass
◦	Use AND to clear all the bits in the PR region
◦	Target PR region bits ANDed with 0's
◦	Other bits ANDed with 1's
2.	Pass
◦	Use OR to set all the bits in the PR region
◦	Target PR region new data Ored with 0's from 1. Pass
◦	other configuration bits Ored with 0's

--> Bigger (twice ) bitstream size than SCRUB
--> PR regions are allowed to overlap

# PR host:
The PR host is the user created logic that actually executes partial reconfiguration, it communicates with the hard PR control block on the FPGA.
The host can be implemented as a state machine or processor software.
Before the PR process, the host needs to send the signal that freezes appropriate logic around PR region. After the PR process, the host need to unfreeze and then reset the PR region.

When performing PR, the PR host sends bitstreams to the PR control block to modify the Configuration RAM bits for a PR region without disrupting CRAM bits in the static region.

# PR bitstreams
The actual PR bitstreams are generated by the Quartus II software (-> Demo) and no user manipulation of the files are needed.

The data being sent represent a frame or column of the CRAM array and the instructions include how to load the data (SRCUB or AND/OR mode) and the location of the column of the CRAM.

Bitstream size cf. 4.5

Control Block interface
The user host controls the PR process by communicating with the PR control blcok.

PR host 								PR control block
		PR_DATA[15:0] 	--->
		PR_CLK		--->
		PR_REQUEST	--->
					<---	PR_ERROR
					<---	PR_READY
					<---	PR_DONE
					<---	CRC_ERROR


PR_REQUEST	request the start of the PR process
PR_READY		response to the request, if ready or not
PR_DONE		indicates if the PR process has completed
PR_ERROR		indicates error during PR process
PR_DATA		bitstream sent by the host to the control block
PR_CLK		PR_DATA sent synchronously to this clock (max. 80MHz)	

Sequence of operations for PR host
1.	host freeze all the local input signals to the appropriate PR region
2.	request PR (set PR_REQUEST to high)
3.	wait for the PR_READY signal to go high
4.	send PR_DATA bitstream
5.	while the process monitor for PR_DONE  or the PR_ERROR signal
6.	if PR_ERROR signal is received, a new PR_REQUEST have to be sent
7.	if PR_DONE signal is received, the host releases the freeze signal and resets the PR region

# Instantiate PR blocks
There are two hard blocks that needs to be connected to the host.
1.	PR control block is a hard-logic block that controls PR process within the device. (you must design logic that communicates with the PR controller block)
2.	The CRC block checks the CRC of the partial bitstream and flags errors.

In the VHDL code you'll need to connect these blocks.

# PR control block
Controls the PR process, most of signals to the control block are handshake signals that interacts with the user host.
CORECTL signal should be tied to VCC (internal host).

In the case of internal host, the ports of the controller needs to be connected with the user internal host using VHDL.

CRC block
Perform cyclic redundancy check on the partial bitstream and flags errors should they occur.

SHIFTNLD 	signal to high
CRCERROR 	signal in VHDL

PR with internal host example -> cf. Ch. 4.25

# PR project flow:
1.	Instantiate control block and implement host
2.	Create PR partitions and LogicLock regions
◦	LogicLock region must be fixed in size, locked in position and reserved so no other logic can be placed in this region
◦	set the partial reconfiguration option to "YES" to ensure your LogicLock region is PR compatible.
3.	Compile base revision
4.	Create and configure reconfigurable revisions
◦	used to manage the different source files for the different personas for the same PR region while reusing the static region compile results from the base revision
◦	need at the minimum as many reconfigurable revisions as the number of personas
◦	in each reconfigurable revision the assignment would point to different source files
5.	Compile every reconfigurable revision
6.	Create programming files for PR project
◦	Generate .pmsf file from .sof and .msf files
◦	Create .rbf files from .pmsf files

# Full chip configuration files
FPGA are volatile SRAM based devices, so at start up they must be programed to a specific function. Full chip configuration files accomplish this and are usually stored in external flash or dedicated configuration device. The SRAM object file or .sof file is the standard default configuration file for FPGA and it is used to program an FPGA through a JTAG connection.

# PR-Related Configuration Files
Partial reconfiguration requires it's own format with different data from the full chip configuration.
Usually PR will require a Raw Binary File .rbf, that contain PR configuration data.
